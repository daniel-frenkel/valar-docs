(self.webpackChunkvalar_docs=self.webpackChunkvalar_docs||[]).push([[264],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return m}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=p(n),m=o,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||i;return n?r.createElement(h,a(a({ref:t},u),{},{components:n})):r.createElement(h,a({ref:t},u))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,a=new Array(i);a[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,a[1]=l;for(var p=2;p<i;p++)a[p]=n[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6184:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return a},metadata:function(){return l},toc:function(){return s},default:function(){return u}});var r=n(2122),o=n(9756),i=(n(7294),n(3905)),a={sidebar_position:3,sidebar_name:"ESPHome"},l={unversionedId:"VAL-1000/ESPHome",id:"VAL-1000/ESPHome",isDocsHomePage:!1,title:"ESPhome Integration",description:"ESPHome V1.18 is required",source:"@site/docs/VAL-1000/ESPHome.md",sourceDirName:"VAL-1000",slug:"/VAL-1000/ESPHome",permalink:"/docs/VAL-1000/ESPHome",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/VAL-1000/ESPHome.md",version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,sidebar_name:"ESPHome"},sidebar:"tutorialSidebar",previous:{title:"StallGuard",permalink:"/docs/VAL-1000/StallGuard"},next:{title:"VALAR W1: Window Opener Setup Instructions",permalink:"/docs/Window Opener/valar_w1"}},s=[{value:"1. Add New Device",id:"1-add-new-device",children:[]},{value:"2. Setting Parameters",id:"2-setting-parameters",children:[{value:"a. pulley_diameter_mm:",id:"a-pulley_diameter_mm",children:[]},{value:"b. gear_ratio:",id:"b-gear_ratio",children:[]},{value:"c. distance_mm:",id:"c-distance_mm",children:[]},{value:"d. acceleration:",id:"d-acceleration",children:[]},{value:"e. velocity:",id:"e-velocity",children:[]},{value:"f. open_current:",id:"f-open_current",children:[]},{value:"g. open_stall_threshold:",id:"g-open_stall_threshold",children:[]},{value:"h. close_current:",id:"h-close_current",children:[]},{value:"i. close_stall_threshold:",id:"i-close_stall_threshold",children:[]},{value:"j. tcool_threshold:",id:"j-tcool_threshold",children:[]},{value:"k. microsteps:",id:"k-microsteps",children:[]}]}],p={toc:s};function u(e){var t=e.components,a=(0,o.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,r.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"ESPHome V1.18 is required")),(0,i.kt)("h2",{id:"1-add-new-device"},"1. Add New Device"),(0,i.kt)("p",null,"Begin by adding a new device in ESPHome. Copy the code below nto the YAML file, completely replacing what is there. "),(0,i.kt)("p",null,'Change the "device_name" to what you\'d like.'),(0,i.kt)("p",null,"Do not change any of the other values at the moment, we will do that later."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'substitutions:\n  device_name: edit-name\n  pulley_diameter_mm: "15" # 1 turn about 47 mm\n  gear_ratio: "1" # not used yet for simplicity\n  distance_mm: "500" # about 10 turns\n  acceleration: 12800 steps/s^2\n  velocity: 12800 steps/s # 1 turn per second\n  open_current: 500ma\n  open_stall_threshold: "20"\n  close_current: 600ma\n  close_stall_threshold: "17"\n  tcool_threshold: "910"\n  microsteps: "64"\n\nexternal_components:\n  source: github://glmnet/esphome@stepper-tmc2209\n  components: [tmc2209]\n\nesphome:\n  name: ${device_name}\n  platform: ESP32\n  board: nodemcu-32s\n  platformio_options:\n    upload_speed: 921600\n\n  on_boot:\n    - tmc2209.setup:\n        microsteps: 64\n        tcool_threshold: ${tcool_threshold}\n        current: 600mA\n        stall_threshold: 20\n\nwifi:\n  ssid: !secret wifi_ssid\n  password: !secret wifi_pass\n\n# Enable logging\nlogger:\n  level: INFO\n\n# verbose logger over uart causes motor artifacts as pulses are generated in main loop\n# logger:\n#   level: VERY_VERBOSE\n#   logs:\n#     api: DEBUG\n#     api.service: DEBUG\n#     scheduler: DEBUG\n\nota:\n\nuart:\n  id: uart_stepper\n  tx_pin: GPIO17\n  rx_pin: GPIO16\n  baud_rate: 9600\n\nstatus_led:\n  pin: GPIO26\n\napi:\n  services:\n    - service: control_stepper\n      variables:\n        target: int\n        speed: int\n        microsteps: int\n        tcool_threshold: int\n        stall_threshold: int\n        rms_current_amps: float\n      then:\n        - tmc2209.setup:\n            id: my_stepper\n            microsteps: !lambda "return microsteps;"\n            tcool_threshold: !lambda "return tcool_threshold;"\n            stall_threshold: !lambda "return stall_threshold;"\n            current: !lambda "return rms_current_amps;"\n        - logger.log:\n            format: moving to %d\n            args: [target]\n        - stepper.set_speed:\n            id: my_stepper\n            speed: !lambda "return speed;"\n        - stepper.set_target:\n            id: my_stepper\n            target: !lambda "return target;"\n    - service: set_stepper_zero\n      then:\n        - stepper.report_position:\n            id: my_stepper\n            position: 0\n        - stepper.set_target:\n            id: my_stepper\n            target: 0\nbinary_sensor:\n  - platform: gpio\n    name: Button1\n    pin:\n      number: GPIO23\n      inverted: true\n    on_press:\n      then:\n        if:\n          condition:\n            lambda: "return id(my_stepper).target_position == 0;"\n          then:\n            stepper.set_target:\n              id: my_stepper\n              target: 128000\n          else:\n            stepper.set_target:\n              id: my_stepper\n              target: 0\n\n  - platform: gpio\n    name: Button2\n    pin:\n      number: GPIO34\n      inverted: true\n      mode: INPUT_PULLUP\n    on_press:\n      script.execute: stop_at_current_position\n\n  - platform: gpio\n    name: Sensor1\n    pin:\n      number: GPIO22\n      inverted: true\n  - platform: gpio\n    name: SensorGPIO0\n    pin:\n      number: GPIO0\n      inverted: true\n  - platform: gpio\n    name: Sensor2\n    pin:\n      number: GPIO32\n      inverted: true\n  - platform: gpio\n    id: stall_guard_sensor\n    name: StallGuard\n    pin: GPIO2\n    on_press:\n      script.execute: stop_at_current_position\n\nstepper:\n  - platform: tmc2209\n    id: my_stepper\n\n    step_pin: GPIO13\n    dir_pin: GPIO14\n\n    sleep_pin:\n      number: GPIO27\n      inverted: true\n    acceleration: ${acceleration}\n    max_speed: ${velocity}\n\nscript:\n  - id: stop_at_current_position\n    then:\n      stepper.set_target:\n        id: my_stepper\n        target: !lambda "return id(my_stepper).current_position;"\n\nglobals:\n  - id: open_position\n    type: float\n    initial_value: ${distance_mm} / (${pulley_diameter_mm} * PI) * 200 * ${microsteps}\n\ncover:\n  - platform: template\n    id: template_cov\n    name: "${device_name} cover"\n    open_action:\n      - tmc2209.setup:\n          current: ${open_current}\n          stall_threshold: ${open_stall_threshold}\n      - stepper.set_target:\n          id: my_stepper\n          target: !lambda "return id(open_position);"\n\n    close_action:\n      - tmc2209.setup:\n          current: ${close_current}\n          stall_threshold: ${close_stall_threshold}\n      - stepper.set_target:\n          id: my_stepper\n          # 0 Means closed\n          target: 0\n\n    position_action:\n      - stepper.set_target:\n          id: my_stepper\n          target: !lambda "return id(open_position) * pos;"\n\n    stop_action:\n      - script.execute: stop_at_current_position\n\ninterval:\n  interval: 1s\n  then:\n    lambda: |-\n      static auto operation = COVER_OPERATION_IDLE;\n      static auto position = id(my_stepper).current_position;\n      if (operation != id(template_cov).current_operation ||\n          position != id(my_stepper).current_position)\n      {\n        ESP_LOGD("main", "Stepper Position is: %d/%d", id(my_stepper).current_position, (int)id(open_position));\n        if (id(my_stepper).current_position > id(my_stepper).target_position)\n          operation = COVER_OPERATION_CLOSING;\n        else if (id(my_stepper).current_position < id(my_stepper).target_position)\n          operation = COVER_OPERATION_OPENING;\n        else\n          operation = COVER_OPERATION_IDLE;\n        id(template_cov).current_operation = operation;\n\n        position =  id(my_stepper).current_position;\n        id(template_cov).position = position / id(open_position);\n\n        id(template_cov).publish_state();\n      }\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Be sure 12V power is plugged in to the board")),(0,i.kt)("p",null,"Compile and upload via USB."),(0,i.kt)("p",null,"Test the board by pressing one of the buttons and motion should begin."),(0,i.kt)("h2",{id:"2-setting-parameters"},"2. Setting Parameters"),(0,i.kt)("p",null,"You have the ability to set the following parameters of your device"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"a. pulley_diameter_mm:\nb. gear_ratio:\nc. distance_mm:\nd. acceleration:\ne. velocity:\nf. open_current:\ng. open_stall_threshold:\nh. close_current:\ni. close_stall_threshold:\nj. tcool_threshold:\nk. microsteps:\n")),(0,i.kt)("p",null,"To set the parmeters, you need to update the YAML file and compile and upload it each time you want to change a parameter. This can make it very difficult to dial some of these values in. "),(0,i.kt)("p",null,"To fix this, we've added a service that will allow you to test different values without requiring complilation or upload. Once you dial in the correct value, you can update the YAML file accordingly. This will limit the amount of time you spend on compiling and uploading. "),(0,i.kt)("p",null,"To use the service, navigate to ",(0,i.kt)("strong",{parentName:"p"},"Developer Tools")," --\x3e ",(0,i.kt)("strong",{parentName:"p"},"Services")," tab\nFrom the Service dropdown list, find ESPHome: ","<","YOUR-DEVICE",">","_control_stepper and select it "),(0,i.kt)("p",null,"You will see the following:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"Services",src:n(4282).Z})),(0,i.kt)("p",null,"Use the service to update values and test them out."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"NOTE:")," These values will not save. You will need to update the YAML file with these values."),(0,i.kt)("p",null,"As noted above, changing the values will not save them. This tool is only used for dialing in the correct value. Once the values are determined, go back to the YAML file in ESPHome and update the values in the file. Save and upload the file."),(0,i.kt)("h3",{id:"a-pulley_diameter_mm"},"a. pulley_diameter_mm:"),(0,i.kt)("p",null,"Most motors require a pulley to attach a belt to. Enter the value in milimeter of the diameter of this pulley. A formula will use this value and the distance value to calculate the number of steps to move."),(0,i.kt)("p",null,"If using a lead screw, set the diameter of the lead screw."),(0,i.kt)("h3",{id:"b-gear_ratio"},"b. gear_ratio:"),(0,i.kt)("p",null,'If no gear is used, set this to "1".'),(0,i.kt)("p",null,'If using a gear, set the value of the ratio by using an integer. For example, is using a 7:1 gear (requires 7 input rotations to output 1 rotations) set this value to "7".'),(0,i.kt)("h3",{id:"c-distance_mm"},"c. distance_mm:"),(0,i.kt)("p",null,"What is the total distance, in milimeters, that you need to move."),(0,i.kt)("h3",{id:"d-acceleration"},"d. acceleration:"),(0,i.kt)("p",null,"What is the acceleration value. If using StallGuard, read the StallGuard section before setting this value."),(0,i.kt)("h3",{id:"e-velocity"},"e. velocity:"),(0,i.kt)("p",null,"What is the maximum velocity value."),(0,i.kt)("h3",{id:"f-open_current"},"f. open_current:"),(0,i.kt)("p",null,"Set the open current in milliamps. The maximum for the VAL-1000 is 2000. "),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"DANGER: Be sure to properly match your power supply. Read on to learn more")),(0,i.kt)("p",null,"This is the Root Mean Square (RMS) current, NOT the maximum current. Multiply this value by 1.41 to find the maximum current. "),(0,i.kt)("p",null,"For example, if setting to 2000mA, the max current used by the TMC2209 will be 2000 x 1.41 = 2820mA"),(0,i.kt)("p",null,"In addition, the ESP32 requires up to 500mA during WiFi transmission. "),(0,i.kt)("p",null,"In this scenario, you will need at least a 3.4A power supply."),(0,i.kt)("h3",{id:"g-open_stall_threshold"},"g. open_stall_threshold:"),(0,i.kt)("p",null,"See the StallGuard page to learn more. "),(0,i.kt)("h3",{id:"h-close_current"},"h. close_current:"),(0,i.kt)("p",null,"Set the close current in miliamps. Note the warnings in the open current section."),(0,i.kt)("h3",{id:"i-close_stall_threshold"},"i. close_stall_threshold:"),(0,i.kt)("p",null,"See the StallGuard page to learn more. "),(0,i.kt)("h3",{id:"j-tcool_threshold"},"j. tcool_threshold:"),(0,i.kt)("p",null,"See the StallGuard page to learn more. "),(0,i.kt)("h3",{id:"k-microsteps"},"k. microsteps:"),(0,i.kt)("p",null,"Set the number of microsteps. This is not as straightforward as it may seem so please read. "),(0,i.kt)("p",null,"Set to 64 if you want it to work well. Keep reading to learn more. "),(0,i.kt)("p",null,"The TMC2209 has a feature called Microplyer that automatically turns low step resolutions into 256 microstepssteps. For example, if you set the above value to 1, each step pulse will automatically get turned into 256 microsteps. The downside is that accuracy also goes down, as you cannot set your position to any of the microsteps that microplyer creates. "),(0,i.kt)("p",null,"On the other hand, setting this value to 256 will limit the top speed of the motor because the ESP32 simply cannot generate pulses fast enough to move the motor very fast. "),(0,i.kt)("p",null,"The value 64 is a good sweet spot that allows the TMC2209 to run at its top speed while also remaining as accurate as possible."))}u.isMDXComponent=!0},4282:function(e,t,n){"use strict";t.Z=n.p+"assets/images/services-97728bbc55af8115992a468c490cdc81.png"}}]);