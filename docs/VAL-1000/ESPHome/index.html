<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Valar Systems Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Valar Systems Blog Atom Feed"><title data-react-helmet="true">ESPhome Integration | Valar Systems</title><meta data-react-helmet="true" property="og:url" content="https://daniel-frenkel.github.io/docs/VAL-1000/ESPHome"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="ESPhome Integration | Valar Systems"><meta data-react-helmet="true" name="description" content="ESPHome V1.18 is required"><meta data-react-helmet="true" property="og:description" content="ESPHome V1.18 is required"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://daniel-frenkel.github.io/docs/VAL-1000/ESPHome"><link data-react-helmet="true" rel="alternate" href="https://daniel-frenkel.github.io/docs/VAL-1000/ESPHome" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://daniel-frenkel.github.io/docs/VAL-1000/ESPHome" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.54412775.css">
<link rel="preload" href="/assets/js/runtime~main.66d85c16.js" as="script">
<link rel="preload" href="/assets/js/main.3e153d81.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Documentation</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Documentation</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/intro">Tutorial</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/intro">Valar Documentation</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">3D Printing Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/3D Printing Guides/3D_print_guide">3D Printing Build Guides</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">MorningRope</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/MorningRope/valar_s1">VALAR S1 aka MorningRope</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">VAL-1000</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/VAL-1000/VAL-1000">VAL-1000</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/VAL-1000/StallGuard">StallGuard</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/VAL-1000/ESPHome">ESPhome Integration</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Window Opener</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/Window Opener/valar_w1">VALAR W1: Window Opener Setup Instructions</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">ESPhome Integration</h1></header><div class="markdown"><p><strong>ESPHome V1.18 is required</strong></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-add-new-device"></a>1. Add New Device<a class="hash-link" href="#1-add-new-device" title="Direct link to heading">#</a></h2><p>Begin by adding a new device in ESPHome. Copy the code below nto the YAML file, completely replacing what is there. </p><p>Change the &quot;device_name&quot; to what you&#x27;d like.</p><p>Do not change any of the other values at the moment, we will do that later.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">substitutions:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  device_name: edit-name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pulley_diameter_mm: &quot;15&quot; # 1 turn about 47 mm</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  gear_ratio: &quot;1&quot; # not used yet for simplicity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  distance_mm: &quot;500&quot; # about 10 turns</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  acceleration: 12800 steps/s^2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  velocity: 12800 steps/s # 1 turn per second</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  open_current: 500ma</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  open_stall_threshold: &quot;20&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  close_current: 600ma</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  close_stall_threshold: &quot;17&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tcool_threshold: &quot;910&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  microsteps: &quot;64&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">external_components:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  source: github://glmnet/esphome@stepper-tmc2209</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  components: [tmc2209]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">esphome:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: ${device_name}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  platform: ESP32</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  board: nodemcu-32s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  platformio_options:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    upload_speed: 921600</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  on_boot:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - tmc2209.setup:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        microsteps: 64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tcool_threshold: ${tcool_threshold}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        current: 600mA</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        stall_threshold: 20</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">wifi:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ssid: !secret wifi_ssid</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  password: !secret wifi_pass</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Enable logging</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">logger:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  level: INFO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># verbose logger over uart causes motor artifacts as pulses are generated in main loop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># logger:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#   level: VERY_VERBOSE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#   logs:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#     api: DEBUG</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#     api.service: DEBUG</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#     scheduler: DEBUG</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ota:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">uart:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id: uart_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tx_pin: GPIO17</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  rx_pin: GPIO16</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  baud_rate: 9600</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">status_led:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pin: GPIO26</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">api:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  services:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - service: control_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      variables:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        target: int</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        speed: int</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        microsteps: int</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tcool_threshold: int</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        stall_threshold: int</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rms_current_amps: float</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      then:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - tmc2209.setup:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            microsteps: !lambda &quot;return microsteps;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            tcool_threshold: !lambda &quot;return tcool_threshold;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            stall_threshold: !lambda &quot;return stall_threshold;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            current: !lambda &quot;return rms_current_amps;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - logger.log:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            format: moving to %d</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            args: [target]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - stepper.set_speed:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            speed: !lambda &quot;return speed;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - stepper.set_target:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            target: !lambda &quot;return target;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - service: set_stepper_zero</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      then:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - stepper.report_position:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            position: 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - stepper.set_target:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            target: 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">binary_sensor:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - platform: gpio</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: Button1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pin:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      number: GPIO23</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      inverted: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    on_press:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      then:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          condition:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            lambda: &quot;return id(my_stepper).target_position == 0;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          then:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            stepper.set_target:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              target: 128000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          else:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            stepper.set_target:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              target: 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - platform: gpio</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: Button2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pin:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      number: GPIO34</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      inverted: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      mode: INPUT_PULLUP</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    on_press:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      script.execute: stop_at_current_position</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - platform: gpio</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: Sensor1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pin:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      number: GPIO22</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      inverted: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - platform: gpio</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: SensorGPIO0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pin:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      number: GPIO0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      inverted: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - platform: gpio</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: Sensor2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pin:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      number: GPIO32</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      inverted: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - platform: gpio</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id: stall_guard_sensor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: StallGuard</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pin: GPIO2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    on_press:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      script.execute: stop_at_current_position</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">stepper:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - platform: tmc2209</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    step_pin: GPIO13</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dir_pin: GPIO14</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sleep_pin:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      number: GPIO27</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      inverted: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    acceleration: ${acceleration}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    max_speed: ${velocity}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">script:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - id: stop_at_current_position</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    then:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      stepper.set_target:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        target: !lambda &quot;return id(my_stepper).current_position;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">globals:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - id: open_position</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type: float</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    initial_value: ${distance_mm} / (${pulley_diameter_mm} * PI) * 200 * ${microsteps}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cover:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - platform: template</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id: template_cov</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: &quot;${device_name} cover&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    open_action:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - tmc2209.setup:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          current: ${open_current}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          stall_threshold: ${open_stall_threshold}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - stepper.set_target:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          target: !lambda &quot;return id(open_position);&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    close_action:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - tmc2209.setup:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          current: ${close_current}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          stall_threshold: ${close_stall_threshold}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - stepper.set_target:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          # 0 Means closed</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          target: 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    position_action:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - stepper.set_target:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          id: my_stepper</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          target: !lambda &quot;return id(open_position) * pos;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    stop_action:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - script.execute: stop_at_current_position</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">interval:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  interval: 1s</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  then:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    lambda: |-</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      static auto operation = COVER_OPERATION_IDLE;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      static auto position = id(my_stepper).current_position;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      if (operation != id(template_cov).current_operation ||</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          position != id(my_stepper).current_position)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ESP_LOGD(&quot;main&quot;, &quot;Stepper Position is: %d/%d&quot;, id(my_stepper).current_position, (int)id(open_position));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (id(my_stepper).current_position &gt; id(my_stepper).target_position)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          operation = COVER_OPERATION_CLOSING;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else if (id(my_stepper).current_position &lt; id(my_stepper).target_position)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          operation = COVER_OPERATION_OPENING;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          operation = COVER_OPERATION_IDLE;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        id(template_cov).current_operation = operation;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        position =  id(my_stepper).current_position;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        id(template_cov).position = position / id(open_position);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        id(template_cov).publish_state();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><strong>Be sure 12V power is plugged in to the board</strong></p><p>Compile and upload via USB.</p><p>Test the board by pressing one of the buttons and motion should begin.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-setting-parameters"></a>2. Setting Parameters<a class="hash-link" href="#2-setting-parameters" title="Direct link to heading">#</a></h2><p>You have the ability to set the following parameters of your device</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">a. pulley_diameter_mm:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">b. gear_ratio:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">c. distance_mm:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">d. acceleration:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">e. velocity:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">f. open_current:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">g. open_stall_threshold:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">h. close_current:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">i. close_stall_threshold:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">j. tcool_threshold:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">k. microsteps:</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To set the parmeters, you need to update the YAML file and compile and upload it each time you want to change a parameter. This can make it very difficult to dial some of these values in. </p><p>To fix this, we&#x27;ve added a service that will allow you to test different values without requiring complilation or upload. Once you dial in the correct value, you can update the YAML file accordingly. This will limit the amount of time you spend on compiling and uploading. </p><p>To use the service, navigate to <strong>Developer Tools</strong> --&gt; <strong>Services</strong> tab
From the Service dropdown list, find ESPHome: &lt;YOUR-DEVICE&gt;_control_stepper and select it </p><p>You will see the following</p><p><img alt="Services" src="/assets/images/services-97728bbc55af8115992a468c490cdc81.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="a-pulley_diameter_mm"></a>a. pulley_diameter_mm:<a class="hash-link" href="#a-pulley_diameter_mm" title="Direct link to heading">#</a></h3><p>The current you are using will determine the amount of back EMF created, so first set your current to a level you want. A high current will make the motor louder and stronger. A low current will do the opposite.</p><p><strong>IMPORTANT:</strong> Always use the <strong>least</strong> amount of current needed to make the motor move. This is good for safety reasons, it makes StallGuard more reliable, and runs the motor and driver much cooler, thus extending their lives. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-velocity"></a>2. Velocity:<a class="hash-link" href="#2-velocity" title="Direct link to heading">#</a></h3><p>Next, set the velocity. How fast do you want it to go. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-acceleration"></a>3. Acceleration:<a class="hash-link" href="#3-acceleration" title="Direct link to heading">#</a></h3><p>Next, set the acceleration. StallGuard is not reliable at very low speeds, so a very long and slow acceleration will not be good with StallGuard. Try to accelerate as fast as you can based on your project. Just know during the acceleration phase, StallGuard may not work right awat, so can you risk having it not work until it gets to its operating velocity? </p><p>For example, in my window opener, I cannot risk StallGuard not working. If the window is locked when trying to open the window, damage may occur if StallGuard does not immediately detect the locked window. So I need to accelerate it as quickly as possible to reach its operating velocity. So take some time to get your acceleration right. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="4-tcoolthrs-setting"></a>4. TCOOLTHRS setting:<a class="hash-link" href="#4-tcoolthrs-setting" title="Direct link to heading">#</a></h3><p>Now we can set the TCOOLTHRS value. It is on page 26 of the datasheet. </p><p>This is the velocity threshold at which point stallGuard will activate. StallGuard is not reliable at low speeds so we need to shut it off until a certain speed is reached. It will always trigger the stall pin when starting up in the first few milisecond, even when there is no stall. </p><p>So we need to set the correct velocity value at which point to turn StallGuard on, but this can be very difficult to do because the value is quite hard to figure out. </p><p>Fortunately Iâ€™ve spent a lot of time figuring this out, and created a formula to figure it out.</p><p>TCOOLS = (3089838.00<em>pow(float(VELOCITY),-1.00161534))</em>1.5;</p><p>Simply plug in your VELOCITY value into the formula, and it will give you the threshold value. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5-sgthrs-setting"></a>5. SGTHRS setting<a class="hash-link" href="#5-sgthrs-setting" title="Direct link to heading">#</a></h3><p>Finally, we need to set the SGTHRS value which is the main value to set. It is a value from 0 - 255 as seen on page 55 of the datsheet.</p><p>A value of 0 will turn StallGuard off completely. The higher you go, the more sensitive it will be to tripping.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="my-workflow-for-setting-stallguard"></a>My workflow for setting stallguard:<a class="hash-link" href="#my-workflow-for-setting-stallguard" title="Direct link to heading">#</a></h3><ol><li>First I set StallGaurd value to 0 to turn it off. </li><li>Then I figure out the <strong>minimum</strong> current to set. I need to have just enough current to move whatever needs to be moved, but not any more. If the current is too high, StallGuard will require a lot of force to trip, so donâ€™t set the current any higher than the application calls for. Set it at near zero and slowly inscrease it until your object begins to move.</li><li>Then I figure out what velocity I want and set that.</li><li>Then I figure out what acceleration I want, trying to use the fastest I can for the application</li><li>Then I set the TCOOLTHRS value based on the formula above. In fact, I have it coded into the sketch so it automatically sets when I set the velocity.</li><li>Then I start at SGTHRS value 0 and start moving the motor and applying pressure to it with my fingers. I slowly increase this number until it stalls. Just keep running the motor, applying pressure, and increasing the value. </li></ol><p><strong>Remember:</strong>  A higher SGTHRS value gives a higher sensitivity. A higher value makes StallGuard more sensitive and requires less torque to indicate a stall.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/VAL-1000/ESPHome.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/VAL-1000/StallGuard"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« StallGuard</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Window Opener/valar_w1"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">VALAR W1: Window Opener Setup Instructions Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-add-new-device" class="table-of-contents__link">1. Add New Device</a></li><li><a href="#2-setting-parameters" class="table-of-contents__link">2. Setting Parameters</a><ul><li><a href="#a-pulley_diameter_mm" class="table-of-contents__link">a. pulley_diameter_mm:</a></li><li><a href="#2-velocity" class="table-of-contents__link">2. Velocity:</a></li><li><a href="#3-acceleration" class="table-of-contents__link">3. Acceleration:</a></li><li><a href="#4-tcoolthrs-setting" class="table-of-contents__link">4. TCOOLTHRS setting:</a></li><li><a href="#5-sgthrs-setting" class="table-of-contents__link">5. SGTHRS setting</a></li><li><a href="#my-workflow-for-setting-stallguard" class="table-of-contents__link">My workflow for setting stallguard:</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.66d85c16.js"></script>
<script src="/assets/js/main.3e153d81.js"></script>
</body>
</html>